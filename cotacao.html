<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clube do Livro Infantil ‚Äî Vitrine</title>
  <meta name="description" content="Vitrine de livros infantis com sinopse e link para compra. Indica√ß√µes carinhosas para fam√≠lias e educadores.">
  <meta name="theme-color" content="#f7e7c4">
  <style>
    :root{
      --bg:#fffaf3; /* bege claro */
      --paper:#ffffff;
      --ink:#1f2937; /* cinza escuro */
      --muted:#6b7280; /* cinza m√©dio */
      --brand:#f59e0b; /* √¢mbar */
      --brand-strong:#d97706;
      --accent:#10b981; /* verde */
      --radius:18px;
      --shadow:0 10px 25px rgba(31,41,55,.08);
      --shadow-sm:0 2px 10px rgba(31,41,55,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    a{color:inherit}
    .wrap{max-width:1080px;margin:auto;padding:24px}
    header.hero{display:grid;gap:14px;align-items:center;grid-template-columns:1fr}
    .badge{display:inline-flex;gap:8px;align-items:center;background:var(--paper);border-radius:999px;padding:6px 12px;box-shadow:var(--shadow-sm);font-size:12px;color:var(--brand-strong)}
    .title{font-size:clamp(28px,4vw,40px);line-height:1.1;margin:0}
    .subtitle{margin:0;color:var(--muted);font-size:clamp(14px,2vw,18px)}
    .filters{display:grid;gap:10px;grid-template-columns:1fr; margin-top:14px}
    .controls{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    .control{background:var(--paper);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow-sm);display:flex;align-items:center}
    .control input,.control select{width:100%;border:0;background:transparent;outline:none;font-size:14px;color:var(--ink)}
    .grid{display:grid;gap:18px;margin-top:20px;grid-template-columns:repeat(1, minmax(0,1fr))}
    .card{background:var(--paper);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
    .cover{aspect-ratio:3/4;object-fit:cover;width:100%;background:#f3f4f6}
    .body{padding:14px 16px;display:grid;gap:8px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;background:#f3f4f6;border-radius:999px;padding:6px 10px;color:#374151}
    .title-sm{font-size:18px;margin:2px 0 0 0}
    .syn{color:var(--muted);font-size:14px}
    .cta{display:flex;gap:10px;margin-top:8px}
    .btn{flex:1;display:inline-flex;justify-content:center;align-items:center;gap:8px;border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease}
    .btn.primary{background:var(--brand);color:#111827;box-shadow:var(--shadow-sm)}
    .btn.primary:hover{background:var(--brand-strong)}
    .btn.alt{background:#ecfdf5;color:#065f46}
    .btn:active{transform:translateY(1px)}
    footer{margin:36px 0 10px;color:var(--muted);text-align:center;font-size:14px}

    .empty{display:none;text-align:center;color:var(--muted);padding:36px}

    /* responsive */
    @media (min-width:720px){
      header.hero{grid-template-columns:1.1fr .9fr}
      .filters{grid-template-columns:1.2fr .8fr}
      .grid{grid-template-columns:repeat(3, minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div>
        <span class="badge">‚ú® Curadoria carinhosa ‚Ä¢ Leitura em fam√≠lia</span>
        <h1 class="title">Clube do Livro Infantil</h1>
        <p class="subtitle">Escolha uma hist√≥ria, leia a sinopse e clique para adquirir. Cada livro √© uma sementinha plantada no cora√ß√£o da crian√ßa. </p>
      </div>
      <div>
        <img src="https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop" alt="Livros infantis empilhados" class="cover" style="border-radius:var(--radius);box-shadow:var(--shadow);aspect-ratio:16/11;">
      </div>
    </header>

    <section class="filters">
      <div class="control" title="Buscar por t√≠tulo, autor ou palavras da sinopse">
        <input id="q" type="search" placeholder="Buscar por t√≠tulo, autor ou palavra-chave‚Ä¶" aria-label="Buscar livros" />
      </div>
      <div class="controls">
        <div class="control"><select id="tema" aria-label="Filtrar por tema">
          <option value="">Todos os temas</option>
          <option>Emo√ß√µes</option><option>Amizade</option><option>Rotina</option><option>B√≠blia</option><option>Cl√°ssicos</option>
        </select></div>
        <button class="btn alt" id="limpar" type="button" title="Limpar filtros">Limpar filtros</button>
      </div>
    </section>

    <section class="grid" id="grid" aria-live="polite"></section>
    <div id="empty" class="empty">Nenhum livro encontrado com esses filtros. Tente remover algum filtro ou buscar por outra palavra.</div>

    <footer>
      <p>üíõ Dica: leia em voz alta, com pausas e perguntas. A leitura √© um encontro, n√£o uma corrida.</p>
      <p>¬© <span id="year"></span> Clube do Livro Infantil</p>
    </footer>
  </div>

  <script>
    // ====== CONFIGURA√á√ïES R√ÅPIDAS ======
    const UTM_PARAMS = 'utm_source=instagram&utm_medium=linkinbio&utm_campaign=clube-do-livro';

    // ====== CAT√ÅLOGO EMBARCADO (fallback) ======
    const BOOKS_FALLBACK = [
      {
        id: 'livro-1',
        title: 'O Menino que Engolia o Choro',
        author: 'Gilberto Amaral (dire√ß√£o do curta) ‚Äî indica√ß√£o de leitura tem√°tica',
        theme: 'Emo√ß√µes',
        cover: 'https://images.unsplash.com/photo-1516979187457-637abb4f9353?q=80&w=1200&auto=format&fit=crop',
        synopsis: 'Uma hist√≥ria para conversar sobre chorar, sentir e pedir ajuda. Excelente porta de entrada para falar de sentimentos com a crian√ßa.',
        affiliate: 'https://exemplo.com/produto/menino-choro',
      },
      {
        id: 'livro-2',
        title: 'A Lagarta Muito Comilona',
        author: 'Eric Carle',
        theme: 'Rotina',
        cover: 'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=1200&auto=format&fit=crop',
        synopsis: 'Cl√°ssico para trabalhar dias da semana, alimenta√ß√£o e transforma√ß√£o. √ìtimo para leitura participativa.',
        affiliate: 'https://exemplo.com/produto/lagarta-comilona',
      },
      {
        id: 'livro-3',
        title: 'O Grande Dia do Pequeno Urso',
        author: 'R. K. Morrow',
        theme: 'Amizade',
        cover: 'https://images.unsplash.com/photo-1531983412531-1f49a365ffed?q=80&w=1200&auto=format&fit=crop',
        synopsis: 'Narrativa doce e simples que acolhe o cotidiano dos bem pequenos. Ideal para criar rituais de leitura antes de dormir.',
        affiliate: 'https://exemplo.com/produto/pequeno-urso',
      },
      {
        id: 'as-aventuras-do-tempo',
        title: 'As Aventuras do Tempo',
        author: 'M√≠riam Leit√£o',
        theme: 'Emo√ß√µes',
        cover: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop',
        synopsis: 'Mel √© uma menina fascinada por hist√≥rias. Um dia, ela disse √† vov√≥ Beth: ‚ÄúMe conta uma hist√≥ria de quando voc√™ era crian√ßa!‚Äù. A vov√≥ ent√£o leva Mel em uma aventura atrav√©s do tempo, recordando momentos da pr√≥pria inf√¢ncia. Tudo fica ainda mais emocionante quando as duas avan√ßam ainda mais no passado e Mel conhece uma hist√≥ria vivida pela bisav√≥ de Beth, √†s margens do rio Doce, ao lado de um amiguinho ind√≠gena que luta para defender a mata. Neste livro cheio de lembran√ßas e afeto, M√≠riam Leit√£o trabalha a no√ß√£o de tempo e transmite uma mensagem comovente de respeito, amizade e mem√≥ria.',
        affiliate: 'https://mercadolivre.com/sec/2YbpY2H',
      },
    ];

    // ====== ELEMENTOS ======
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const tema = document.getElementById('tema');
    const limpar = document.getElementById('limpar');

    // ====== HELPERS ======
    function buildAffiliateUrl(link, id){
      try{
        const hasQuery = link.includes('?');
        const sep = hasQuery ? '&' : '?';
        return link + sep + UTM_PARAMS + '&book_id=' + encodeURIComponent(id || '');
      }catch(e){
        return link; // fallback
      }
    }

    // ====== RENDER ======
    function cardTpl(b){
      const safeHref = buildAffiliateUrl(b.affiliate, b.id || b.title);
      const themeBadge = b.theme ? '<span class="tag">' + b.theme + '</span>' : '';
      return (
        '<article class="card" data-theme="' + (b.theme || '') + '">' +
          '<img class="cover" loading="lazy" alt="Capa do livro ' + (b.title||'') + '" src="' + (b.cover||'') + '">' +
          '<div class="body">' +
            '<div class="tags">' + themeBadge + '</div>' +
            '<h3 class="title-sm">' + (b.title||'') + '</h3>' +
            '<div class="syn">' + (b.synopsis||'') + '</div>' +
            '<div class="syn" style="font-size:12px">Autor(a): ' + (b.author||'') + '</div>' +
            '<div class="cta">' +
              '<a class="btn primary" href="' + safeHref + '" target="_blank" rel="noopener" aria-label="Comprar ' + (b.title||'') + '">Quero este livro</a>' +
            '</div>' +
          '</div>' +
        '</article>'
      );
    }

    function render(list){
      grid.innerHTML = list.map(cardTpl).join('');
      empty.style.display = list.length ? 'none' : 'block';
    }

    // ====== BUSCA/FILTRO ======
    function normalize(str){return (str||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');}
    function applyFilters(){
      const term = normalize(q?.value);
      const fTema = tema?.value || '';
      const filtered = BOOKS_DATA.filter(b => {
        const text = normalize(`${b.title} ${b.author} ${b.synopsis}`);
        const byTerm = !term || text.includes(term);
        const byTema = !fTema || (b.theme===fTema);
        return byTerm && byTema;
      });
      render(filtered);
    }

    q?.addEventListener('input', applyFilters);
    tema?.addEventListener('change', applyFilters);
    limpar?.addEventListener('click', () => { if(q) q.value=''; if(tema) tema.value=''; applyFilters(); });

    // ====== ADMIN (COLAR LINK DA PLANILHA) ======
    const STORAGE_KEY = 'clube_livro_sheet_url';
    const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlxSrLpml1izk1Xmy9QKJZSRezhDu7Wrqh9AuRnL09XP6eZQAOX_937nw-XYzgbaY-7xbf1uwL9jcK/pub?gid=1276009145&single=true&output=csv';

    function showAdminIfNeeded(){
      const params = new URLSearchParams(location.search);
      const isAdmin = params.get('admin')==='1' || location.hash==='#admin';
      if(!isAdmin) return;
      // Estilos do painel
      const style = document.createElement('style');
      style.textContent = `.admin-btn{position:fixed;right:16px;bottom:16px;padding:10px 12px;border-radius:12px;border:0;box-shadow:0 6px 20px rgba(0,0,0,.12);background:#fff;font-weight:600;cursor:pointer}
      .admin-panel{position:fixed;inset:auto 16px 72px 16px;max-width:680px;margin-left:auto;background:#fff;border-radius:16px;box-shadow:0 30px 60px rgba(0,0,0,.18);padding:18px 16px;}
      .admin-panel h3{margin:6px 0 10px 0}
      .admin-panel label{font-size:14px;color:#374151;display:block;margin:8px 0 6px}
      .admin-row{display:grid;gap:8px;grid-template-columns:1fr auto}
      .admin-panel input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
      .admin-panel .small{font-size:12px;color:#6b7280;margin-top:8px}
      .admin-actions{display:flex;gap:8px;margin-top:12px}
      .admin-actions button{border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
      .admin-save{background:#f59e0b}
      .admin-clear{background:#f3f4f6}
      `;
      document.head.appendChild(style);

      // Bot√£o e painel
      const btn = document.createElement('button');
      btn.id = 'adminBtn';
      btn.className = 'admin-btn';
      btn.textContent = '‚öôÔ∏è Admin';

      const panel = document.createElement('div');
      panel.className = 'admin-panel';
      panel.innerHTML = `
        <h3>Configurar planilha do cat√°logo (Google Sheets)</h3>
        <label for="sheetUrl">Cole aqui o link PUBLICADO da sua planilha (CSV)</label>
        <div class="admin-row">
          <input id="sheetUrl" type="url" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv" />
          <button class="admin-save">Salvar & Carregar</button>
        </div>
        <div class="admin-actions">
          <button class="admin-clear">Desconectar planilha</button>
        </div>
        <div class="small">
          <strong>Como fazer:</strong> 1) Crie uma planilha com as colunas: <em>title, author, theme, synopsis, cover, affiliate, publish</em>. 2) No Google Sheets: Arquivo ‚Üí Compartilhar ‚Üí <em>Publicar na Web</em> ‚Üí selecionar a aba ‚Üí formato CSV ‚Üí Copiar link. 3) Cole o link acima e clique em "Salvar & Carregar". <br/>
          Use a coluna <em>publish</em> = <code>1</code> para publicar o livro (linhas sem 1 ficam ocultas).
        </div>
      `;

      btn.addEventListener('click', () => {
        panel.style.display = panel.style.display==='none' ? 'block' : 'none';
      });

      document.body.appendChild(btn);
      document.body.appendChild(panel);

      const input = panel.querySelector('#sheetUrl');
      const save = panel.querySelector('.admin-save');
      const clear = panel.querySelector('.admin-clear');

      const stored = localStorage.getItem(STORAGE_KEY);
      input.value = stored || DEFAULT_SHEET_URL || '';

      save.addEventListener('click', async () => {
        const url = input.value.trim();
        if(!url){ alert('Cole o link CSV publicado da sua planilha.'); return; }
        localStorage.setItem(STORAGE_KEY, url);
        await loadFromSheet(url);
        panel.style.display = 'none';
      });

      clear.addEventListener('click', () => {
        localStorage.removeItem(STORAGE_KEY);
        BOOKS_DATA = [...BOOKS_FALLBACK];
        applyFilters();
        alert('Planilha desconectada. Voltamos para a lista padr√£o.');
      });
    }

    // ====== CSV PARSER (simples e compat√≠vel com campos entre aspas) ======
    function parseCSV(str){
      const rows = [];
      let i=0, s=str, cur='', row=[], inQ=false;
      while(i<s.length){
        const c=s[i];
        if(inQ){
          if(c==='"' && s[i+1]==='"'){ cur+='"'; i++; }
          else if(c==='"'){ inQ=false; }
          else { cur+=c; }
        }else{
          if(c==='"'){ inQ=true; }
          else if(c===','){ row.push(cur); cur=''; }
          else if(c==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
          else if(c==='\r'){ /* ignore */ }
          else { cur+=c; }
        }
        i++;
      }
      if(cur.length||row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    async function fetchCsvWithFallback(url){
      // 1¬™ tentativa: fetch direto (pode falhar por CORS quando abrindo o arquivo via file://)
      try{
        const res = await fetch(url, { cache: 'no-store', mode: 'cors' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt = await res.text();
        if(!txt || !txt.trim()) throw new Error('CSV vazio');
        return txt;
      }catch(err1){
        // 2¬™ tentativa: proxy de leitura p√∫blica com CORS liberado
        const proxied = 'https://r.jina.ai/http://' + url.replace(/^https?:\/\//,'');
        const res2 = await fetch(proxied, { cache: 'no-store' });
        if(!res2.ok) throw new Error('HTTP (proxy) '+res2.status);
        const txt2 = await res2.text();
        if(!txt2 || !txt2.trim()) throw new Error('CSV vazio (proxy)');
        return txt2;
      }
    }

    async function loadFromSheet(csvUrl){
      try{
        const text = await fetchCsvWithFallback(csvUrl);
        const rows = parseCSV(text).filter(r=>r.length && r.some(x=>x&&x.trim()!==''));
        if(rows.length<=1) throw new Error('CSV sem linhas √∫teis');
        const headers = rows[0].map(h => (h||'').toLowerCase().trim());
        const idx = name => headers.indexOf(name);
        const out = [];
        for(let r=1;r<rows.length;r++){
          const c = rows[r];
          const publish = (c[idx('publish')]||'').toString().trim();
          if(publish && publish!=='0' && publish.toLowerCase()!=='false'){
            out.push({
              id: (c[idx('id')]||c[idx('title')]||`book-${r}`).trim(),
              title: (c[idx('title')]||'').trim(),
              author: (c[idx('author')]||'').trim(),
              theme: (c[idx('theme')]||'').trim(),
              synopsis: (c[idx('synopsis')]||'').trim(),
              cover: (c[idx('cover')]||'').trim(),
              affiliate: (c[idx('affiliate')]||'#').trim(),
            });
          }
        }
        if(out.length){
          BOOKS_DATA = out;
          applyFilters();
          return true;
        } else {
          throw new Error('Nenhum livro com publish=1');
        }
      }catch(err){
        console.warn('Erro ao carregar planilha:', err);
        alert('N√£o foi poss√≠vel carregar a planilha. Mantendo a lista padr√£o.');
        BOOKS_DATA = [...BOOKS_FALLBACK];
        applyFilters();
        return false;
      }
    }
        }
        if(out.length){
          BOOKS_DATA = out;
          applyFilters();
          return true;
        }else{
          throw new Error('Nenhum livro com publish=1 foi encontrado');
        }
      }catch(err){
        console.warn('Erro ao carregar planilha:', err);
        alert('N√£o foi poss√≠vel carregar a planilha. Mantendo a lista padr√£o.');
        BOOKS_DATA = [...BOOKS_FALLBACK];
        applyFilters();
        return false;
      }
    }

    // ====== TESTES (executa se ?test=1) ======
    function runTests(){
      const params = new URLSearchParams(location.search);
      if(params.get('test') !== '1') return;
      const results = [];
      function ok(name, cond){ results.push([name, !!cond]); if(!cond) console.error('Teste falhou:', name); }

      // Teste 1: parseCSV com v√≠rgulas e aspas
      const csv = 'title,author,theme,synopsis,cover,affiliate,publish\n"A, B","C","Emo√ß√µes","Texto, com, v√≠rgulas","http://img","https://ex.com?x=1",1';
      const rows = parseCSV(csv);
      ok('CSV tem 2 linhas', rows.length === 2);
      ok('Campo 0 cont√©m "A, B"', rows[1][0] === 'A, B');

      // Teste 2: buildAffiliateUrl junta par√¢metros corretamente
      const url1 = buildAffiliateUrl('https://ex.com/prod', 'id-1');
      ok('UTM com ? quando n√£o h√° query', url1.includes('?utm_source='));
      const url2 = buildAffiliateUrl('https://ex.com/prod?ref=abc', 'id-2');
      ok('UTM com & quando j√° h√° query', /\&utm_source=/.test(url2));

      // Teste 3: cardTpl n√£o quebra com t√≠tulo contendo crase/backtick
      const card = cardTpl({title:'Livro `Especial`', author:'Autor', theme:'Emo√ß√µes', synopsis:'S', cover:'img', affiliate:'https://ex.com'});
      ok('cardTpl retorna string', typeof card === 'string' && card.includes('Livro'));

      const passed = results.filter(r=>r[1]).length;
      console.log('Testes conclu√≠dos:', passed + '/' + results.length, results);
      alert('Testes conclu√≠dos: ' + passed + '/' + results.length + ' (veja o console para detalhes)');
    }

    // ====== BOOT ======
    let BOOKS_DATA = [...BOOKS_FALLBACK];

    // Detectar planilha por querystring (?sheet=) ou localStorage
    (function init(){
      document.getElementById('year').textContent = new Date().getFullYear();
      showAdminIfNeeded();
      const params = new URLSearchParams(location.search);
      const fromParam = params.get('sheet');
      const stored = localStorage.getItem(STORAGE_KEY);
      if(fromParam){
        const url = decodeURIComponent(fromParam);
        localStorage.setItem(STORAGE_KEY, url);
        loadFromSheet(url);
      } else if(stored){
        loadFromSheet(stored);
      } else if (typeof DEFAULT_SHEET_URL !== 'undefined' && DEFAULT_SHEET_URL){
        loadFromSheet(DEFAULT_SHEET_URL);
      } else {
        render(BOOKS_DATA);
      }
      runTests();
    })();
  </script>
</body>
</html>
