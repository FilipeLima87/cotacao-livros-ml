<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clube do Livro Infantil ‚Äî Vitrine</title>
  <meta name="description" content="Vitrine de livros infantis com sinopse e link para compra. Indica√ß√µes carinhosas para fam√≠lias e educadores.">
  <meta name="theme-color" content="#f7e7c4">
  <style>
    :root{
      --bg:#fffaf3; --paper:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --brand:#f59e0b; --brand-strong:#d97706; --radius:18px;
      --shadow:0 10px 25px rgba(31,41,55,.08); --shadow-sm:0 2px 10px rgba(31,41,55,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:inherit}
    .wrap{max-width:1080px;margin:auto;padding:24px}
    header.hero{display:grid;gap:14px;align-items:center;grid-template-columns:1fr}
    .badge{display:inline-flex;gap:8px;align-items:center;background:var(--paper);border-radius:999px;padding:6px 12px;box-shadow:var(--shadow-sm);font-size:12px;color:var(--brand-strong)}
    .title{font-size:clamp(28px,4vw,40px);line-height:1.1;margin:0}
    .subtitle{margin:0;color:var(--muted);font-size:clamp(14px,2vw,18px)}
    .filters{display:grid;gap:10px;grid-template-columns:1fr; margin-top:14px}
    .controls{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .control{background:var(--paper);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow-sm);display:flex;align-items:center}
    .control input,.control select{width:100%;border:0;background:transparent;outline:none;font-size:14px;color:var(--ink)}
    .grid{display:grid;gap:18px;margin-top:20px;grid-template-columns:repeat(1, minmax(0,1fr))}
    .card{background:var(--paper);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
    .cover{aspect-ratio:3/4;object-fit:cover;width:100%;background:#f3f4f6}
    .body{padding:14px 16px;display:grid;gap:8px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{font-size:12px;background:#f3f4f6;border-radius:999px;padding:6px 10px;color:#374151}
    .title-sm{font-size:18px;margin:2px 0 0 0}
    .syn{color:var(--muted);font-size:14px}
    .cta{display:flex;gap:10px;margin-top:8px}
    .btn{flex:1;display:inline-flex;justify-content:center;align-items:center;gap:8px;border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease}
    .btn.primary{background:var(--brand);color:#111827;box-shadow:var(--shadow-sm)}
    .btn.primary:hover{background:var(--brand-strong)}
    .btn:active{transform:translateY(1px)}
    footer{margin:36px 0 10px;color:var(--muted);text-align:center;font-size:14px}
    .empty{display:none;text-align:center;color:var(--muted);padding:36px}
    @media (min-width:720px){
      header.hero{grid-template-columns:1.1fr .9fr}
      .filters{grid-template-columns:1.2fr .8fr}
      .grid{grid-template-columns:repeat(3, minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div>
        <span class="badge">‚ú® Curadoria carinhosa ‚Ä¢ Leitura em fam√≠lia</span>
        <h1 class="title">Clube do Livro Infantil</h1>
        <p class="subtitle">Escolha uma hist√≥ria, leia a sinopse e clique para adquirir. Cada livro √© uma sementinha plantada no cora√ß√£o da crian√ßa.</p>
      </div>
      <div>
        <img src="https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop" alt="Livros infantis empilhados" class="cover" style="border-radius:var(--radius);box-shadow:var(--shadow);aspect-ratio:16/11;">
      </div>
    </header>

    <section class="filters">
      <div class="control" title="Buscar por t√≠tulo, autor ou palavras da sinopse">
        <input id="q" type="search" placeholder="Buscar por t√≠tulo, autor ou palavra-chave‚Ä¶" aria-label="Buscar livros" />
      </div>
      <div class="controls">
        <div class="control"><select id="tema" aria-label="Filtrar por tema">
          <option value="">Todos os temas</option>
          <option>Emo√ß√µes</option><option>Amizade</option><option>Rotina</option><option>B√≠blia</option><option>Cl√°ssicos</option>
        </select></div>
        <button class="btn primary" id="limpar" type="button" title="Limpar filtros">Limpar filtros</button>
      </div>
    </section>

    <section class="grid" id="grid" aria-live="polite"></section>
    <div id="empty" class="empty">Nenhum livro encontrado com esses filtros. Tente remover algum filtro ou buscar por outra palavra.</div>

    <footer>
      <p>üíõ Dica: leia em voz alta, com pausas e perguntas. A leitura √© um encontro, n√£o uma corrida.</p>
      <p>¬© <span id="year"></span> Clube do Livro Infantil</p>
    </footer>
  </div>

  <script>
    const UTM_PARAMS = 'utm_source=instagram&utm_medium=linkinbio&utm_campaign=clube-do-livro';
    const STORAGE_KEY = 'clube_livro_sheet_url';
    // sua planilha publicada:
    const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlxSrLpml1izk1Xmy9QKJZSRezhDu7Wrqh9AuRnL09XP6eZQAOX_937nw-XYzgbaY-7xbf1uwL9jcK/pub?gid=1276009145&single=true&output=csv';

    const BOOKS_FALLBACK = [
      { id:'as-aventuras-do-tempo', title:'As Aventuras do Tempo', author:'M√≠riam Leit√£o', theme:'Emo√ß√µes',
        cover:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop',
        synopsis:'Mel √© uma menina fascinada por hist√≥rias. Um dia, ela disse √† vov√≥ Beth: ‚ÄúMe conta uma hist√≥ria de quando voc√™ era crian√ßa!‚Äù. A vov√≥ ent√£o leva Mel em uma aventura atrav√©s do tempo, recordando momentos da pr√≥pria inf√¢ncia. Tudo fica ainda mais emocionante quando as duas avan√ßam ainda mais no passado e Mel conhece uma hist√≥ria vivida pela bisav√≥ de Beth, √†s margens do rio Doce, ao lado de um amiguinho ind√≠gena que luta para defender a mata. Neste livro cheio de lembran√ßas e afeto, M√≠riam Leit√£o trabalha a no√ß√£o de tempo e transmite uma mensagem comovente de respeito, amizade e mem√≥ria.',
        affiliate:'https://mercadolivre.com/sec/2YbpY2H' },
      { id:'lagarta-muito-comilona', title:'A Lagarta Muito Comilona', author:'Eric Carle', theme:'Rotina',
        cover:'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=1200&auto=format&fit=crop',
        synopsis:'Cl√°ssico para trabalhar dias da semana, alimenta√ß√£o e transforma√ß√£o. √ìtimo para leitura participativa.',
        affiliate:'https://exemplo.com/produto/lagarta-comilona' },
      { id:'pequeno-urso', title:'O Grande Dia do Pequeno Urso', author:'R. K. Morrow', theme:'Amizade',
        cover:'https://images.unsplash.com/photo-1531983412531-1f49a365ffed?q=80&w=1200&auto=format&fit=crop',
        synopsis:'Narrativa doce e simples que acolhe o cotidiano dos bem pequenos. Ideal para criar rituais de leitura antes de dormir.',
        affiliate:'https://exemplo.com/produto/pequeno-urso' }
    ];

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const tema = document.getElementById('tema');
    const limpar = document.getElementById('limpar');

    function buildAffiliateUrl(link, id){
      try{
        const sep = link.includes('?') ? '&' : '?';
        return link + sep + UTM_PARAMS + '&book_id=' + encodeURIComponent(id||'');
      }catch(e){ return link; }
    }

    function cardTpl(b){
      const href = buildAffiliateUrl(b.affiliate, b.id || b.title);
      const badge = b.theme ? '<span class="tag">'+b.theme+'</span>' : '';
      return (
        '<article class="card" data-theme="'+(b.theme||'')+'">'+
          '<img class="cover" loading="lazy" alt="Capa do livro '+(b.title||'')+'" src="'+(b.cover||'')+'">'+
          '<div class="body">'+
            '<div class="tags">'+badge+'</div>'+
            '<h3 class="title-sm">'+(b.title||'')+'</h3>'+
            '<div class="syn">'+(b.synopsis||'')+'</div>'+
            '<div class="syn" style="font-size:12px">Autor(a): '+(b.author||'')+'</div>'+
            '<div class="cta"><a class="btn primary" href="'+href+'" target="_blank" rel="noopener">Quero este livro</a></div>'+
          '</div>'+
        '</article>'
      );
    }

    function render(list){
      grid.innerHTML = list.map(cardTpl).join('');
      empty.style.display = list.length ? 'none' : 'block';
    }

    function normalize(str){ return (str||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }
    function applyFilters(){
      const term = normalize(q?.value);
      const fTema = tema?.value || '';
      const filtered = BOOKS_DATA.filter(b=>{
        const text = normalize((b.title||'')+' '+(b.author||'')+' '+(b.synopsis||''));
        const byTerm = !term || text.includes(term);
        const byTema = !fTema || b.theme===fTema;
        return byTerm && byTema;
      });
      render(filtered);
    }

    q?.addEventListener('input', applyFilters);
    tema?.addEventListener('change', applyFilters);
    limpar?.addEventListener('click', ()=>{ if(q) q.value=''; if(tema) tema.value=''; applyFilters(); });

    // CSV parser simples (suporta aspas/virgulas)
    function parseCSV(str){
      const rows=[]; let i=0,s=str,cur='',row=[],inQ=false;
      while(i<s.length){
        const c=s[i];
        if(inQ){
          if(c=='"' && s[i+1]=='"'){ cur+='"'; i++; }
          else if(c=='"'){ inQ=false; }
          else { cur+=c; }
        }else{
          if(c=='"'){ inQ=true; }
          else if(c==','){ row.push(cur); cur=''; }
          else if(c=='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
          else if(c=='\r'){ /* ignore */ }
          else { cur+=c; }
        }
        i++;
      }
      if(cur.length||row.length){ row.push(cur); rows.push(row); }
      return rows;
    }

    async function fetchCsvWithFallback(url){
      try{
        const r = await fetch(url, {cache:'no-store', mode:'cors'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const t = await r.text();
        if(!t.trim()) throw new Error('CSV vazio');
        return t;
      }catch(e){
        const prox = 'https://r.jina.ai/http://' + url.replace(/^https?:\/\//,'');
        const r2 = await fetch(prox, {cache:'no-store'});
        if(!r2.ok) throw new Error('HTTP (proxy) '+r2.status);
        const t2 = await r2.text();
        if(!t2.trim()) throw new Error('CSV vazio (proxy)');
        return t2;
      }
    }

    async function loadFromSheet(csvUrl){
      try{
        const text = await fetchCsvWithFallback(csvUrl);
        const rows = parseCSV(text).filter(r=>r.length && r.some(x=>x&&x.trim()!==''));
        if(rows.length<=1) throw new Error('CSV sem linhas');
        const headers = rows[0].map(h=>(h||'').toLowerCase().trim());
        const idx = name => headers.indexOf(name);
        const out=[];
        for(let r=1;r<rows.length;r++){
          const c = rows[r];
          const publish = (c[idx('publish')]||'').toString().trim();
          if(publish && publish!=='0' && publish.toLowerCase()!=='false'){
            out.push({
              id:(c[idx('id')]||c[idx('title')]||('book-'+r)).trim(),
              title:(c[idx('title')]||'').trim(),
              author:(c[idx('author')]||'').trim(),
              theme:(c[idx('theme')]||'').trim(),
              synopsis:(c[idx('synopsis')]||'').trim(),
              cover:(c[idx('cover')]||'').trim(),
              affiliate:(c[idx('affiliate')]||'#').trim(),
            });
          }
        }
        if(!out.length) throw new Error('Sem publish=1');
        BOOKS_DATA = out;
        applyFilters();
      }catch(err){
        console.warn('Erro ao carregar planilha:', err);
        alert('N√£o foi poss√≠vel carregar a planilha. Mantendo a lista padr√£o.');
        BOOKS_DATA = [...BOOKS_FALLBACK];
        applyFilters();
      }
    }

    let BOOKS_DATA = [...BOOKS_FALLBACK];

    (function init(){
      document.getElementById('year').textContent = new Date().getFullYear();
      const params = new URLSearchParams(location.search);
      const fromParam = params.get('sheet');
      const stored = localStorage.getItem(STORAGE_KEY);
      if(fromParam){
        const url = decodeURIComponent(fromParam);
        localStorage.setItem(STORAGE_KEY, url);
        loadFromSheet(url);
      }else if(stored){
        loadFromSheet(stored);
      }else if(DEFAULT_SHEET_URL){
        loadFromSheet(DEFAULT_SHEET_URL);
      }else{
        render(BOOKS_DATA);
      }
    })();
  </script>
</body>
</html>
